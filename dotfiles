#!/usr/bin/env bash

# ============================================================================
# Dotfiles Manager
# Helper script to manage your dotfiles
# ============================================================================

set -e

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
EDITOR="${EDITOR:-nvim}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Helper functions
print_success() { echo -e "${GREEN}‚úì${NC} $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1"; }
print_info() { echo -e "${BLUE}‚Ñπ${NC}  $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC}  $1"; }

print_header() {
  echo ""
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${CYAN}  $1${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
}

# Check if in dotfiles directory
check_dotfiles_dir() {
  if [ ! -d "$DOTFILES_DIR" ]; then
    print_error "Dotfiles directory not found: $DOTFILES_DIR"
    print_info "Set DOTFILES_DIR env variable or run from dotfiles directory"
    exit 1
  fi
}

# ============================================================================
# Commands
# ============================================================================

cmd_status() {
  print_header "üìä Dotfiles Status"
  cd "$DOTFILES_DIR"
  
  echo -e "${YELLOW}Git Status:${NC}"
  git status -sb
  echo ""
  
  echo -e "${YELLOW}Symlinks:${NC}"
  for file in nvim ghostty yazi; do
    if [ -L "$HOME/.config/$file" ]; then
      target=$(readlink "$HOME/.config/$file")
      if [ "$target" = "$DOTFILES_DIR/$file" ]; then
        print_success "$HOME/.config/$file ‚Üí $target"
      else
        print_warning "$HOME/.config/$file ‚Üí $target (unexpected)"
      fi
    else
      print_error "$HOME/.config/$file (not a symlink)"
    fi
  done
  
  for file in zshrc zshenv zprofile; do
    if [ -L "$HOME/.$file" ]; then
      target=$(readlink "$HOME/.$file")
      if [ "$target" = "$DOTFILES_DIR/$file" ]; then
        print_success "$HOME/.$file ‚Üí $target"
      else
        print_warning "$HOME/.$file ‚Üí $target (unexpected)"
      fi
    else
      print_error "$HOME/.$file (not a symlink)"
    fi
  done
}

cmd_sync() {
  print_header "üîÑ Syncing with GitHub"
  cd "$DOTFILES_DIR"
  
  # Check for uncommitted changes
  if ! git diff-index --quiet HEAD --; then
    print_warning "You have uncommitted changes:"
    git status -s
    echo ""
    echo -e "${YELLOW}Commit them? (y/n)${NC}"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
      git add .
      echo "Commit message:"
      read -r message
      git commit -m "$message"
    fi
  fi
  
  # Pull and push
  print_info "Pulling from remote..."
  git pull --rebase
  
  print_info "Pushing to remote..."
  git push
  
  print_success "Synced successfully!"
}

cmd_backup() {
  print_header "üíæ Creating Backup"
  
  BACKUP_DIR="$HOME/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"
  mkdir -p "$BACKUP_DIR"
  
  print_info "Backing up to: $BACKUP_DIR"
  
  # Backup symlinked files
  for file in nvim ghostty yazi; do
    if [ -d "$HOME/.config/$file" ]; then
      cp -r "$HOME/.config/$file" "$BACKUP_DIR/"
      print_success "Backed up: $file"
    fi
  done
  
  for file in zshrc zshenv zprofile zlogin zlogout zpreztorc; do
    if [ -f "$HOME/.$file" ]; then
      cp "$HOME/.$file" "$BACKUP_DIR/"
      print_success "Backed up: .$file"
    fi
  done
  
  print_success "Backup complete: $BACKUP_DIR"
}

cmd_edit() {
  print_header "‚úèÔ∏è  Edit Dotfiles"
  
  if [ -z "$1" ]; then
    # Open dotfiles directory in editor
    cd "$DOTFILES_DIR"
    $EDITOR .
  else
    # Edit specific file
    case "$1" in
      nvim)
        $EDITOR "$DOTFILES_DIR/nvim/init.lua"
        ;;
      zsh)
        $EDITOR "$DOTFILES_DIR/zshrc"
        ;;
      ghostty)
        $EDITOR "$DOTFILES_DIR/ghostty/config"
        ;;
      yazi)
        $EDITOR "$DOTFILES_DIR/yazi/yazi.toml"
        ;;
      starship)
        $EDITOR "$DOTFILES_DIR/starship.toml"
        ;;
      *)
        print_error "Unknown config: $1"
        print_info "Available: nvim, zsh, ghostty, yazi, starship"
        exit 1
        ;;
    esac
  fi
}

cmd_update() {
  print_header "‚¨ÜÔ∏è  Updating Everything"
  
  # Homebrew
  print_info "Updating Homebrew packages..."
  brew update && brew upgrade
  print_success "Homebrew updated"
  
  # Neovim plugins
  print_info "Updating Neovim plugins..."
  nvim --headless "+Lazy! sync" +qa
  print_success "Neovim plugins updated"
  
  # Prezto
  if [ -d "$HOME/.zprezto" ]; then
    print_info "Updating Prezto..."
    cd "$HOME/.zprezto"
    git pull && git submodule update --init --recursive
    print_success "Prezto updated"
  fi
  
  # Git pull dotfiles
  print_info "Pulling dotfiles updates..."
  cd "$DOTFILES_DIR"
  git pull
  print_success "Dotfiles updated"
}

cmd_check() {
  print_header "üè• Health Check"
  
  # Check symlinks
  print_info "Checking symlinks..."
  local all_good=true
  
  for file in nvim ghostty yazi; do
    if [ ! -L "$HOME/.config/$file" ]; then
      print_error "$HOME/.config/$file is not a symlink"
      all_good=false
    fi
  done
  
  for file in zshrc zshenv; do
    if [ ! -L "$HOME/.$file" ]; then
      print_error "$HOME/.$file is not a symlink"
      all_good=false
    fi
  done
  
  if [ "$all_good" = true ]; then
    print_success "All symlinks OK"
  fi
  
  # Check Neovim
  print_info "Checking Neovim..."
  nvim --version | head -1
  
  # Check health
  print_info "Running Neovim health check..."
  echo "Run manually: nvim +checkhealth"
  
  # Check Git status
  print_info "Checking Git..."
  cd "$DOTFILES_DIR"
  if git diff-index --quiet HEAD --; then
    print_success "No uncommitted changes"
  else
    print_warning "You have uncommitted changes"
  fi
}

cmd_install() {
  print_header "üì¶ Installing Dotfiles"
  
  if [ -f "$DOTFILES_DIR/install.sh" ]; then
    cd "$DOTFILES_DIR"
    ./install.sh "$@"
  else
    print_error "install.sh not found in $DOTFILES_DIR"
    exit 1
  fi
}

cmd_help() {
  cat << EOF
${CYAN}Dotfiles Manager${NC}

${YELLOW}Usage:${NC}
  dotfiles <command> [options]

${YELLOW}Commands:${NC}
  ${GREEN}status${NC}          Show git status and symlinks
  ${GREEN}sync${NC}            Commit and push/pull changes
  ${GREEN}backup${NC}          Create backup of current configs
  ${GREEN}edit [config]${NC}   Edit dotfiles (nvim, zsh, ghostty, yazi, starship)
  ${GREEN}update${NC}          Update everything (brew, nvim plugins, prezto)
  ${GREEN}check${NC}           Health check (symlinks, neovim, git)
  ${GREEN}install${NC}         Run installation script
  ${GREEN}help${NC}            Show this help

${YELLOW}Examples:${NC}
  dotfiles status           # Check current state
  dotfiles sync             # Sync with GitHub
  dotfiles edit nvim        # Edit Neovim config
  dotfiles update           # Update all tools
  dotfiles check            # Health check

${YELLOW}Environment:${NC}
  DOTFILES_DIR    Dotfiles location (default: $HOME/.dotfiles)
  EDITOR          Editor to use (default: nvim)

EOF
}

# ============================================================================
# Main
# ============================================================================

main() {
  check_dotfiles_dir
  
  case "${1:-help}" in
    status|st)
      cmd_status
      ;;
    sync)
      cmd_sync
      ;;
    backup|bak)
      cmd_backup
      ;;
    edit|e)
      shift
      cmd_edit "$@"
      ;;
    update|up)
      cmd_update
      ;;
    check|health)
      cmd_check
      ;;
    install)
      shift
      cmd_install "$@"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      print_error "Unknown command: $1"
      echo "Run 'dotfiles help' for usage"
      exit 1
      ;;
  esac
}

main "$@"
